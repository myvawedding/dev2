"use strict";var _createClass=function(){function o(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,e,r){return e&&o(t.prototype,e),r&&o(t,r),t}}(),_get=function t(e,r,o){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,r);if(void 0===i){var n=Object.getPrototypeOf(e);return null===n?void 0:t(n,r,o)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(o):void 0};function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}!function(a){DRTS.Location=DRTS.Location||{},DRTS.Location.leaflet=DRTS.Location.leaflet||{},DRTS.Location.leaflet.map=function(t){function i(t,e){_classCallCheck(this,i);var r=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,e)),o={zoomControl:!1,zoom:r.options.default_zoom,scrollWheelZoom:r.options.scrollwheel,center:L.latLng(r.options.default_location.lat,r.options.default_location.lng),layers:[L.tileLayer("//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{id:"osm",attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'})]};return r.map=L.map(r.$map.get(0),o),L.control.zoom({position:"bottomright"}).addTo(r.map),r.currentCircle=null,r.markerCluster=null,r.options.marker_clusters&&(r.markerCluster=L.markerClusterGroup()),r.options.infobox&&r.map.on("movestart zoomstart",function(t){r.getPopover().sabaiPopover("hide"),r.currentMarker=null}),r.map.on("click",function(t){r.container.trigger("map_clicked.sabai",{latlng:[t.latlng.lat,t.latlng.wrap().lng]})}),r.map.on("zoomend",function(t){r.container.trigger("map_zoom_changed.sabai",{zoom:r.map.getZoom()})}),r}return _inherits(i,DRTS.Map.map),_createClass(i,[{key:"clearMarkers",value:function(){for(var t in this.markers)this.map.removeLayer(this.markers[t]);return this.markerCluster&&this.markerCluster.clearLayers(),_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"clearMarkers",this).call(this)}},{key:"addMarker",value:function(t){var e=void 0,r=void 0,o={riseOnHover:!0};return this.options.marker_custom&&(r=t.icon?DRTS.Location.leaflet.map.divIcon({html:t.icon.url?a("<img/>").attr("src",t.icon.url)[0].outerHTML:null,icon:t.icon.icon||this.options.marker_icon,icon_color:t.icon.icon_color||this.options.marker_icon_color,size:t.icon.size||this.options.marker_size,color:t.icon.color||this.options.marker_color||"#fff"}):DRTS.Location.leaflet.map.divIcon({icon:this.options.marker_icon||"fas fa-dot-circle",icon_color:this.options.marker_icon_color,size:this.options.marker_size,color:this.options.marker_color||"#fff"}),o.icon=r),(e=L.marker([t.lat,t.lng],o))._id=t.entity_id+"-"+t.index,e._content=t.content,e._entity_id=t.entity_id,this.markers[e._id]=e,this}},{key:"getMarkerPosition",value:function(t){if(null==t&&(t=Object.keys(this.markers)[0]),!1!=t in this.markers){var e=this.markers[t].getLatLng();return[e.lat,e.lng]}}},{key:"draw",value:function(t){var e=this;if(t=t||{},this.currentMarker=null,this.currentCircle&&this.currentCircle.remove(),0<Object.keys(this.markers).length){var r=void 0,o=[];for(var i in r=void 0===t.fit_bounds?this.options.fit_bounds:t.fit_bounds,Object.keys(this.markers).length<=1&&(r=!1),this.markers){if(this.markerCluster||this.markers[i].addTo(this.map),r){var n=this.markers[i].getLatLng();o.push(n),t.center&&o.push([2*t.center[0]-n.lat,2*t.center[1]-n.lng])}this.markers[i].on(this.options.infobox_event,function(e,r){return function(t){e.clickMarker(r)}}(this,this.markers[i]))}this.markerCluster&&(this.markerCluster.addLayers(Object.values(this.markers)),this.map.addLayer(this.markerCluster)),r?this.map.fitBounds(o):(t.center||(t.center=this.markers[Object.keys(this.markers)[0]].getLatLng()),setTimeout(function(){e.map.invalidateSize()},500))}return t.center&&(this.map.setView(t.center,t.zoom||this.options.default_zoom||10),t.circle&&(this.currentCircle=L.circle(t.center,t.circle.radius,{color:t.circle.stroke_color||"#99f",opacity:.8,weight:1,fill:!0,fillColor:t.circle.fill_color||"#99f",fillOpacity:.3}).addTo(this.map))),a(DRTS).trigger("map_drawn.sabai",{map:this}),this}},{key:"clickMarker",value:function(t,e){var r=this;return this.currentMarker&&this.currentMarker._id===t._id?(this.showMarkerContent(t,e),void(e||this.container.trigger("marker_click.sabai",{map:this,marker:t}))):(e&&this.markerCluster&&(this.currentMarker&&this.markerCluster.addLayer(this.currentMarker),this.markerCluster.removeLayer(t),t.addTo(this.map)),this.map.getBounds()&&!this.map.getBounds().contains(t.getLatLng())?(this.map.panTo(t.getLatLng(),{duration:.25}),setTimeout(function(){r.showMarkerContent(t)},300)):this.showMarkerContent(t,e),this.currentMarker&&this.currentMarker.setZIndexOffset(200),t.setZIndexOffset(1e3),this.currentMarker=t,e||this.container.trigger("marker_click.sabai",{map:this,marker:t}),this)}},{key:"showMarkerContent",value:function(t,e){var r=this.getPopover();if(r&&r.sabaiPopover("hide"),!e&&this.options.infobox||t.bounce({duration:400,height:50}),(!e||this.options.trigger_infobox)&&r&&t._content)return r=this.getPopover(this.map.latLngToContainerPoint(t.getLatLng()),t._marker_height||39,t._content).sabaiPopover("show"),this}},{key:"onResized",value:function(){return this.map.invalidateSize(),this}},{key:"getZoom",value:function(){return this.map.getZoom()}},{key:"getSouthWest",value:function(){var t=this.map.getBounds();return[t.getSouthWest().lat,t.getSouthWest().lng]}},{key:"getNorthEast",value:function(){var t=this.map.getBounds();return[t.getNorthEast().lat,t.getNorthEast().lng]}}]),i}(),DRTS.Location.leaflet.map.divIcon=function(t){var e=document.createElement("div"),r=t.size||39;e.className="drts-map-marker",e.style.width=r+"px",e.style.height=r+"px",e.style.marginTop="-"+(r*Math.sqrt(2)-DRTS.Map.markerHeight(r))+"px";var o=document.createElement("div");return t.color&&(e.style.backgroundColor=e.style.color=o.style.borderColor=t.color),t.data&&(e.dataset=t.data),t.html?o.innerHTML=t.html:t.icon&&(o.innerHTML='<i class="'+t.icon+'"></i>',t.icon_color&&(o.style.backgroundColor=t.icon_color)),e.appendChild(o),L.divIcon({html:e.outerHTML,iconSize:[0,0]})},DRTS.Map.api.getMap=function(t,e){return new DRTS.Location.leaflet.map(t,e)}}(jQuery);