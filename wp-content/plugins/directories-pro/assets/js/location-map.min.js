"use strict";!function(b){DRTS.Location=DRTS.Location||{},DRTS.Location.map=DRTS.Location.map||function(o){var n=o.getOptions();if(!b(DRTS).data("initialized-"+o.getContainerSelector())){var t=o.getContainer().find(".drts-view-entities-container");if(0<t.length){b(DRTS).on("loaded.sabai",function(t,e){e.container===o.getContainerSelector()&&e.target.hasClass("drts-view-entities-container")&&(e.target.hasClass("drts-location-map-full")&&b(".drts-location-entities-container").animate({scrollTop:0},500,"swing"),e.response.markers&&Array.isArray(e.response.markers)&&o.clearMarkers().setMarkers(e.response.markers).draw(e.response.draw_options),o.getContainer().find(".drts-location-map-control > i").removeClass("fa-spin"))});t.hoverIntent(function(t){t.preventDefault();var e=b(t.currentTarget),i=void 0,a=void 0;if(e.hasClass("drts-entity"))i=e,a=0;else{if(!(i=e.closest(".drts-entity")).length)return;a=e.data("key")}var n=o.getMarker(i.data("entity-id")+"-"+a);n&&o.clickMarker(n,!0)},function(){},".drts-map-marker-trigger, .drts-entity")}o.getContainer().on("marker_click.sabai",function(t,e){if(o.getContainer().find(".drts-highlighted").removeClass("drts-highlighted"),n.scroll_to_item&&e.marker){var i=void 0;if(i=e.marker.get?e.marker.get("entity_id"):e.marker._entity_id){var a=o.getContainer().find('.drts-entity[data-entity-id="'+i+'"]');a.length&&a.is(":visible")&&DRTS.Location.scrollToItem(a,function(){a.addClass("drts-highlighted")})}}}),b(DRTS).data("initialized-"+o.getContainerSelector(),!0)}DRTS.Location.enableMapControls(o,n),n.sticky&&DRTS.Location.stickyScroll(o)},b(DRTS).on("map_drawn.sabai",function(t,e){e.map&&e.map.getContainer().find(".drts-map-map").closest(".drts-location-entities-map-container").length&&(DRTS.Location.map(e.map),b(e.map.getContainerSelector()+"-view-filter-form").on("shown.bs.collapse hidden.bs.collapse",function(){DRTS.Location.stickyScroll(e.map,!1),DRTS.Location.stickyScroll(e.map)}))}),DRTS.Location.stickyScroll=function(t,e,i){if(b.fn.stickyScroll){var a=t.getContainer().find(".drts-map-container");if(!1===e)a.stickyScroll(!1).css({position:"relative",top:"",width:""});else{if(null==e){var n=0<b("#wpadminbar").length?b("#wpadminbar").outerHeight():0,o=t.getContainer().find(".drts-location-map-container-container");if(0<o.length)if(o.data("sticky-scroll-top"))n=o.data("sticky-scroll-top");else if(o.data("sticky-scroll-top-selector")){var r=b(o.data("sticky-scroll-top-selector"));0<r.length&&(n=r.outerHeight())}e={topSpacing:n,stopper:t.getContainerSelector()+" .drts-location-sticky-scroll-stopper",namespace:t.getContainer().attr("id")||"stickyScroll"}}void 0!==i&&i||"undefined"==typeof imagesLoaded?a.stickyScroll(e):b("body").imagesLoaded(function(){a.stickyScroll(e)})}}},DRTS.Location.enableMapControls=function(f,p){if(!f.getContainer().find(".drts-location-map-controls").length){var t=b('<div class="drts-location-map-controls"></div>');p.fullscreen&&(t.append(b('<button class="'+DRTS.bsPrefix+"d-none "+DRTS.bsPrefix+"d-sm-block "+DRTS.bsPrefix+"btn "+DRTS.bsPrefix+"btn-sm "+DRTS.bsPrefix+'btn-light drts-location-map-control" data-action="fullscreen" rel="sabaitooltip" data-placement="right" title="Full screen"><i class="fas fa-expand"></i></button>')),t.append(b('<button class="'+DRTS.bsPrefix+"d-none "+DRTS.bsPrefix+"d-sm-block "+DRTS.bsPrefix+"btn "+DRTS.bsPrefix+"btn-sm "+DRTS.bsPrefix+'btn-light drts-location-map-control" data-action="exit_fullscreen" rel="sabaitooltip" data-placement="right" title="Exit full screen"><i class="fas fa-compress"></i></button>'))),t.append(b('<button class="'+DRTS.bsPrefix+"btn "+DRTS.bsPrefix+"btn-sm "+DRTS.bsPrefix+'btn-light drts-location-map-control" style="display:none;" data-action="update" rel="sabaitooltip" data-placement="right" title="Search this area"><i class="fas fa-sync"></i></button>')),t.append(b('<button class="'+DRTS.bsPrefix+"btn "+DRTS.bsPrefix+"btn-sm "+DRTS.bsPrefix+'btn-light drts-location-map-control" style="display:none;" data-action="geolocate" rel="sabaitooltip" data-placement="right" title="Search my location"><i class="fas fa-location-arrow"></i></button>')),f.getContainer().find(".drts-map-container").prepend(t);var e=b('.drts-view-filter-form[data-entities-container="'+f.getContainerSelector()+'"]'),m=!1;if(0<e.length){var g=e.find(".drts-view-filter-form-field-type-location-address");if(0<g.length){m=!0;var u=1;g.data("search-my-loc")&&(!navigator.geolocation||"https:"!==document.location.protocol&&"localhost"!==document.location.hostname||t.find('.drts-location-map-control[data-action="geolocate"]').show(),u=g.data("search-my-loc-radius")),g.data("search-this-area")&&t.find('.drts-location-map-control[data-action="update"]').show()}}var i=f.getContainer().find(".drts-map-map"),h=i.outerHeight(),v=i.outerWidth();t.on("click",".drts-location-map-control",function(t){t.preventDefault();var e=b(this);switch(e.data("action")){case"update":case"geolocate":if(!m)break;var i=b('.drts-view-filter-form[data-entities-container="'+f.getContainerSelector()+'"]');if(!i.length)return this;switch(i.find(".drts-view-filter-form-field-type-location-address").each(function(){DRTS.View.removeFilter(i,b(this).data("view-filter-name"))}),e.find("> i").addClass("fa-spin"),e.data("action")){case"update":var a=f.getSouthWest(),n=f.getNorthEast();i.find(".drts-location-text-viewport").val([a[0],a[1],n[0],n[1]].join(",")).end().find(".drts-location-text-center").val("").end().find(".drts-location-text-radius").val("").end().find(".drts-location-text-zoom").val(f.getZoom()).end().find(".drts-location-text-input").val(g.data("search-this-area-label")),i.find('input[name^="search_location_location"]').val("").end().submit();break;case"geolocate":navigator.geolocation.getCurrentPosition(function(t){i.find(".drts-location-text-viewport").val("").end().find(".drts-location-text-center").val(t.coords.latitude+","+t.coords.longitude).end().find(".drts-location-text-radius").val(u).end().find(".drts-location-text-zoom").val("").end().find(".drts-location-text-input").val(g.data("search-my-loc-label")),i.find('input[name^="search_location_location"]').val("").end().submit()},function(t){e.find("> i").removeClass("fa-spin"),DRTS.flash(t.message+" ("+t.code+")","danger")},{enableHighAccuracy:!0,timeout:1e4})}break;case"fullscreen":case"exit_fullscreen":var o=f.getContainer().find(".drts-view-entities-container"),r=o.hasClass("drts-view-entities-container-map"),s=r?null:o.find(".drts-location-map-container-container"),l=o.find(".drts-location-entities-map-container");switch(e.data("action")){case"fullscreen":var d=b("#wpadminbar").length?b("#wpadminbar").outerHeight(!0):0;0<l.length&&l.data("fullscreen-offset")&&(d=l.data("fullscreen-offset"));var c=b(window).outerHeight()-d;o.addClass("drts-location-map-full").css("top",d).toggleClass("drts-location-map-full-no-filter",0===b(f.getContainerSelector()+"-view-filter-form").length),r||(o.find(".drts-location-entities-container").outerHeight(c).find(".drts-location-entities").before(o.find(".drts-view-entities-header")).before(o.find(".drts-view-entities-filter-form")).after(o.find(".drts-view-entities-footer")).end().end(),s.length&&(o.find(".drts-location-entities-with-map").removeClass("drts-location-entities-with-map-top").end().find(".drts-location-entities-container").removeClass(DRTS.bsPrefix+"col-sm-"+(12-s.data("span"))).addClass(DRTS.bsPrefix+"col-sm-"+(12-s.data("fullscreen-span"))),s.removeClass(DRTS.bsPrefix+"col-sm-"+s.data("span")).addClass(DRTS.bsPrefix+"col-sm-"+s.data("fullscreen-span")),p.sticky&&DRTS.Location.stickyScroll(f,!1))),o.find(".drts-map-map").outerWidth("100%").outerHeight(c),b(window).on("resize.sabai",{container:o,offset:d},function(t){var e=b(window).outerHeight()-t.data.offset;t.data.container.find(".drts-location-entities-container").outerHeight(e).end().find(".drts-map-map").outerHeight(e)}),b("body").css("overflow","hidden"),f.onResized(),b(DRTS).trigger("location_fullscreen.sabai",{container:f.getContainer()});break;case"exit_fullscreen":o.removeClass("drts-location-map-full drts-location-map-full-no-filter").find(".drts-map-map").outerWidth(v).outerHeight(h),r||(o.find("> .drts-view-entities").before(o.find(".drts-view-entities-header")).before(o.find(".drts-view-entities-filter-form")).after(o.find(".drts-view-entities-footer")).end().find(".drts-location-entities-container").css("height","100%"),s.length&&(o.find(".drts-location-entities-with-map").toggleClass("drts-location-entities-with-map-top","top"===s.data("position")).end().find(".drts-location-entities-container").removeClass(DRTS.bsPrefix+"col-sm-"+(12-s.data("fullscreen-span"))).addClass(DRTS.bsPrefix+"col-sm-"+(12-s.data("span"))),s.removeClass(DRTS.bsPrefix+"col-sm-"+s.data("fullscreen-span")).addClass(DRTS.bsPrefix+"col-sm-"+s.data("span")),p.sticky&&DRTS.scrollTo(o,null,null,function(){DRTS.Location.stickyScroll(f,null,!0)}))),b(window).off("resize.sabai"),b("body").css("overflow",""),f.onResized(),b(DRTS).trigger("location_exit_fullscreen.sabai",{container:f.getContainer()})}f.draw(),window.cqApi&&window.cqApi.reevaluate(!1)}}),b(window).on("entity_reset_form_field.sabai",function(t,e){if("filter_location_address"===e){var i=b('.drts-view-filter-form[data-entities-container="'+f.getContainerSelector()+'"]');if(!i.length)return this;i.find(".drts-location-text-viewport").val("").end().find(".drts-location-text-center").val("").end().find(".drts-location-text-radius").val("").end().find(".drts-location-text-zoom").val("").end().find(".drts-location-text-input").val("")}})}},DRTS.Location.scrollToItem=function(t,e){var i=t.closest(".drts-view-entities-container");if(i.length&&!i.hasClass("drts-view-entities-container-map"))if(i.hasClass("drts-location-map-full")){var a=i.find(".drts-location-entities-container");a.length&&a.animate({scrollTop:a.scrollTop()-a.offset().top+t.offset().top},500,"swing",e)}else{var n=i.find(".drts-location-map-container-container"),o=40;"top"===n.data("position")&&(o+=n.find(".drts-map-map").outerHeight()),b("html,body").animate({scrollTop:t.offset().top-o},500,"swing",e)}}}(jQuery);