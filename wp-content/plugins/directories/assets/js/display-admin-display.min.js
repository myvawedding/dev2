"use strict";function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}!function(y){DRTS.Display=DRTS.Display||{},DRTS.Display.adminDisplay=function(m){var t,a,l,d=(m=y.extend({selector:"#drts-display",formSelector:"#drts-display",name:"elements",listElementsUrl:null,addElementUrl:null,addElementTitle:null,editElementUrl:null,editElementTitle:null,deleteElementTitle:null,deleteConfirm:null,elementTypes:{}},m)).formSelector?y(m.formSelector):null,n=function(){var e=y(this);return c(),e.sabaiTooltip("hide"),e.attr("data-modal-title")||e.attr("data-modal-title",e.data("element-type")?m.addElementTitle+" - "+m.elementTypes[e.data("element-type")]:m.addElementTitle),DRTS.ajax({type:"get",container:"#drts-modal",url:m.listElementsUrl,data:e.data("element-type")?{type:e.data("element-type")}:null,onErrorFlash:!0,onContent:function(e,t,a){t.find(".drts-display-elements").off("click",".drts-display-element",s).on("click",".drts-display-element",{parentId:a.closest(".drts-display-element").data("element-id")||0},s)},trigger:e,cache:!0,cacheId:e.data("element-type")?m.listElementsUrl+"-"+e.data("element-type"):m.listElementsUrl}),!1},s=function(e){e.data=e.data||{};var t=y(this),a=t.closest(".drts-display-element"),l=e.data.parentId||a.data("element-id")||0;return c(),t.sabaiTooltip("hide"),t.attr("data-modal-title")||t.attr("data-modal-title",m.addElementTitle+" - "+m.elementTypes[a.data("element-type")]+" - "+a.data("element-label")),DRTS.ajax({type:"get",container:"#drts-modal",url:m.addElementUrl,data:{element:t.data("element-name")},onSendData:function(e,t){},onContent:function(e,t,a){t.find("#drts-display-add-element-parent").val(l)},onErrorFlash:!0,trigger:t,cache:!0,cacheId:"drts-display-element-name-"+t.data("element-name")}),!1},e=function(){var e=y(this),l=e.closest(".drts-display-element");return l.addClass("drts-display-element-editing"),c(),e.attr("data-modal-title")||e.attr("data-modal-title",m.editElementTitle+" - "+m.elementTypes[l.data("element-type")]+" - "+l.data("element-label")+" (ID: "+l.data("element-id")+")"),DRTS.ajax({type:"get",container:"#drts-modal",url:m.editElementUrl,data:{element_id:l.data("element-id")},onContent:function(e,t,a){l.removeClass("drts-display-element-editing")},onErrorFlash:!0,trigger:e,cache:!0,cacheId:"drts-display-element-id-"+l.data("element-id")}),!1},r=function(e,t,a){var l=e.find("> .drts-display-element-title");t.title&&t.title.length?l.find(".drts-display-element-label").html(t.title).removeClass("drts-display-element-no-label"):l.find(".drts-display-element-label").text(t.label).addClass("drts-display-element-no-label"),a&&t.icon&&l.prepend('<span class="drts-display-element-icon"><i class="fa-fw '+t.icon+'"></i></span>')},i=function(e){d&&d.length?(o(),e?t||(t=setTimeout(function(){d.submit()},!0===e?2e3:e)):d.submit()):a=!0},o=function(){t&&(clearTimeout(t),t=null)},p=function(e){e.hasClass("drts-display-element-containable")?e.find("> .drts-display-element-title").effect("highlight",{},1e3):e.effect("highlight",{},1e3)},c=function(){y(m.selector).find(".drts-popover-processed").sabaiPopover("hide")},f={items:"> .drts-display-element",placeholder:"drts-display-element-placeholder",opacity:.8,handle:".drts-display-element-handle",tolerance:"intersect",zIndex:99999,start:function(e,t){var a=t.helper.find(".drts-display-element-title").outerHeight()-2;l=!0,c(),t.helper.height(a).css({overflow:"hidden",width:t.helper.find(".drts-display-element-handle").outerWidth()+32}),t.placeholder.height(a),t.item.data("element-width")&&t.placeholder.css("width",t.item.data("element-width")),o()},update:function(e,t){i(!0)},over:function(e,t){var a=y(this);a.data("child-element-type")&&t.item.data("element-type")!==a.data("child-element-type")||a.data("child-element-name")&&t.item.data("element-name")!==a.data("child-element-name")||a.data("child-element-attr")&&!t.item.data(a.data("child-element-attr"))||t.item.data("parent-element-name")&&a.closest(".drts-display-element").data("element-name")!==t.item.data("parent-element-name")?(t.item.find(".drts-display-element-handle").css("cursor","no-drop"),t.placeholder.addClass(DRTS.bsPrefix+"bg-danger")):(t.item.find(".drts-display-element-handle").css("cursor","move"),t.placeholder.removeClass(DRTS.bsPrefix+"bg-danger"))},out:function(e,t){t.item.css("cursor","move")},stop:function(e,t){l=!1,t.item.css({overflow:"visible",cursor:"auto"})},receive:function(e,t){var a=y(this);(a.data("child-element-type")&&t.item.data("element-type")!==a.data("child-element-type")||a.data("child-element-name")&&t.item.data("element-name")!==a.data("child-element-name")||a.data("child-element-attr")&&!t.item.data(a.data("child-element-attr"))||t.item.data("parent-element-name")&&a.closest(".drts-display-element").data("element-name")!==t.item.data("parent-element-name"))&&t.sender.sortable("cancel")}};y(".drts-display-element-wrapper",m.selector).each(function(){var e=y(this).sortable(f);e.data("child-element-name")||e.sortable("option","connectWith",m.selector+" .drts-display-element-wrapper:not([data-child-element-name])")}),y(".drts-display-display",m.selector).on("click",".drts-display-element-delete",function(){if(!confirm(m.deleteConfirm))return!1;c();var e=y(this).closest(".drts-display-element");return e.fadeTo("fast",0,function(){e.slideUp("medium",function(){e.remove()})}),i(!0),!1}),y(DRTS).on("display_element_created.sabai",function(e,t){var a='.drts-display-display[data-display-id="'+t.result.display_id+'"]';t.result.parent_id&&(a+=' .drts-display-element[data-element-id="'+t.result.parent_id+'"]'),a+=" > .drts-display-element-wrapper";var l=y(m.selector).find(a);if(l.length){var d=function a(t,e){var l='<div class="drts-display-element" data-element-id="" data-element-type=""><div class="drts-display-element-title"><span class="drts-display-element-handle"><i class="fas fa-arrows-alt fa-fw fa-lg"></i> <span class="drts-display-element-label"></span></span></div><div class="drts-display-element-control"><div class="drts-bs-btn-group"><button class="drts-display-element-info drts-bs-btn drts-bs-btn-info drts-bs-btn-sm"><i class="fas fa-info fa-fw"></i></button><button class="drts-display-element-edit drts-bs-btn drts-bs-btn-primary drts-bs-btn-sm"><i class="fas fa-cog fa-fw"></i></button><button class="drts-display-element-delete drts-bs-btn drts-bs-btn-danger drts-bs-btn-sm"><i class="fas fa-trash-alt fa-fw"></i></button><button class="drts-display-add-element drts-bs-btn drts-bs-btn-success drts-bs-btn-sm" rel="sabaitooltip" title="'+m.addElementTitle+'" data-placement="right"><i class="fas fa-plus fa-fw"></i></button></div></div><input type="hidden" name="'+m.name+'[]" value="" /></div>',d=y(l).attr("data-element-id",t.id).attr("data-element-type",t.type).attr("data-element-name",t.name).attr("data-element-label",t.label).data("element-data",t.data).addClass("drts-display-element-name-"+t.name).toggleClass("drts-display-element-dimmed",t.dimmed).find('input[name="'+m.name+'[]"]').val(t.id).end().appendTo(e).find('[rel*="sabaitooltip"]').sabaiTooltip({container:e}).end().show();if(t.attr&&y.each(t.attr,function(e,t){d.attr(e,t)}),r(d,t,!0),t.containable){l='<input type="hidden" name="'+m.name+'[]" value="__CHILDREN_START__" /><div class="drts-display-element-wrapper"></div><input type="hidden" name="'+m.name+'[]" value="__CHILDREN_END__" />';var n,s=d.addClass("drts-display-element-containable").append(l).find(".drts-display-add-element").attr("title",t.add_child_label).end().find(" > .drts-display-element-wrapper").sortable(f);if(t.child_element_name)d.find(".drts-display-add-element").attr("data-element-name",t.child_element_name),s.attr("data-child-element-name",t.child_element_name),DRTS.cache("drts-display-element-name-"+t.child_element_name)||y.get(m.addElementUrl,(_defineProperty(n={},DRTS.params.ajax,"#drts-modal"),_defineProperty(n,"element",t.child_element_name),n),function(e){DRTS.cache(m.addElementsUrl+"-"+t.child_element_name,e)});else if(t.child_element_type){var i;d.find(".drts-display-add-element").attr("data-element-type",t.child_element_type),s.attr("data-child-element-type",t.child_element_type),DRTS.cache(m.listElementsUrl+"-"+t.child_element_type)||y.get(m.listElementsUrl,(_defineProperty(i={},DRTS.params.ajax,"#drts-modal"),_defineProperty(i,"type",t.child_element_type),i),function(e){DRTS.cache(m.listElementsUrl+"-"+t.child_element_type,e)}),s.sortable("option","connectWith",".drts-display-element-wrapper")}else s.sortable("option","connectWith",".drts-display-element-wrapper");t.children&&y.each(t.children,function(e,t){a(t,s)})}else d.find(".drts-display-add-element").remove();return d}(t.result,l);p(d),DRTS.cache("drts-display-element-name-"+d.data("element-name"),!1),i()}}),y(DRTS).on("display_element_updated.sabai",function(e,t){var a=y(m.selector).find('.drts-display-element[data-element-id="'+t.result.id+'"]');if(a.length){if(t.result.attr&&y.each(t.result.attr,function(e,t){a.attr(e,t)}),a.toggleClass("drts-display-element-dimmed",t.result.dimmed),t.result.data){a.data("element-data",t.result.data);var l=a.find(".drts-display-element-info");l.hasClass("drts-popover-processed")&&l.removeClass("drts-popover-processed").sabaiPopover("dispose")}r(a,t.result),p(a),DRTS.cache("drts-display-element-id-"+a.data("element-id"),!1)}}),d&&d.length?d.on("submit",function(){var e=y(this);return!0,t=null,DRTS.ajax({type:e.attr("method"),container:e,url:e.attr("action"),data:e.serialize(),onSuccess:function(e,t,a){},onErrorFlash:!0,loadingImage:!1}),!1}):y(m.selector).closest("form").on("submit",function(){a=!1}),y(window).on("beforeunload",function(){if(d&&d.length)t&&i();else if(a)return""}),y(function(){y.get(m.listElementsUrl,_defineProperty({},DRTS.params.ajax,"#drts-modal"),function(e){DRTS.cache(m.listElementsUrl,e),y(".drts-display-display",m.selector).on("click",".drts-display-add-element:not([data-element-name])",n),y(".drts-display-add-element-main",m.selector).prop("disabled",!1)}),y(".drts-display-add-element[data-element-name]",m.selector).each(function(){var e,t=y(this).prop("disabled",!0),a=t.data("element-name");DRTS.cache("drts-display-element-name-"+a)||y.get(m.addElementUrl,(_defineProperty(e={},DRTS.params.ajax,"#drts-modal"),_defineProperty(e,"element",a),e),function(e){DRTS.cache(m.addElementUrl+"-"+a,e),t.prop("disabled",!1)})}),y(".drts-display-add-element[data-element-type]",m.selector).each(function(){var e,t=y(this).prop("disabled",!0),a=t.data("element-type");DRTS.cache(m.listElementsUrl+"-"+a)||y.get(m.listElementsUrl,(_defineProperty(e={},DRTS.params.ajax,"#drts-modal"),_defineProperty(e,"type",a),e),function(e){DRTS.cache(m.listElementsUrl+"-"+a,e),t.prop("disabled",!1)})}),y(".drts-display-display",m.selector).on("click",".drts-display-element-edit",e).on("click",".drts-display-add-element[data-element-name]",s).on("click",".drts-display-element-info",function(e){var t=y(this);e.preventDefault(),t.toggleClass("drts-display-element-info-clicked").closest(".drts-display-element-control").toggleClass("drts-display-element-info-clicked"),t.off("hidden.bs.popover").on("hidden.bs.popover",function(){t.removeClass("drts-display-element-info-clicked").closest(".drts-display-element-control").removeClass("drts-display-element-info-clicked")})}),y(".drts-display-display",m.selector).hoverIntent({selector:".drts-display-element-info",over:function(e){var t=y(this);if(!l)if(y(m.selector).find(".drts-popover-processed").not(this).sabaiPopover("hide"),t.hasClass("drts-popover-processed"))t.sabaiPopover("show");else{var a=t.closest(".drts-display-element"),i=y("<table></table>"),r=a.data("element-data");i.attr("class","drts-display-element-data "+DRTS.bsPrefix+"table "+DRTS.bsPrefix+"table-bordered "+DRTS.bsPrefix+"table-sm "+DRTS.bsPrefix+"m-0"),Object.keys(r).forEach(function(d){var n=!0,e=Object.keys(r[d].value),s=e.length;e.forEach(function(e){var t=y("<td></td>").text(r[d].value[e].label+":"),a=y("<td></td>"),l=y("<tr></tr>").append(t).append(a).appendTo(i);r[d].value[e].is_html?a.html(r[d].value[e].value):r[d].value[e].is_bool?a.html('<i class="fas '+(r[d].value[e].value?"fa-check":"fa-times")+'"></i>'):a.text(r[d].value[e].value),n&&(l.prepend(y('<th class="'+DRTS.bsPrefix+'table-secondary" rowspan="'+s+'"></th>').text(r[d].label)),n=!1)})}),DRTS.popover(t,{html:!0,trigger:"manual",placement:"top",container:m.selector,content:i,template:'<div class="'+DRTS.bsPrefix+'popover"><div class="'+DRTS.bsPrefix+'arrow"></div><div class="'+DRTS.bsPrefix+"popover-body "+DRTS.bsPrefix+'p-1"></div></div>'})}},out:function(e){y(this).hasClass("drts-display-element-info-clicked")||c()}}),y(".drts-display-display",m.selector).on("click",".drts-display-element-title",function(){var e=y(this);e.hasClass("drts-popover-processed")&&e.sabaiPopover("toggle")})})}}(jQuery);