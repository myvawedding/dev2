"use strict";var _createClass=function(){function l(e,t){for(var a=0;a<t.length;a++){var l=t[a];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}return function(e,t,a){return t&&l(e.prototype,t),a&&l(e,a),e}}();function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(c){DRTS.Display=DRTS.Display||{},DRTS.Display.adminDisplays=function(){function a(e,t){var d=this;_classCallCheck(this,a),this.form=c(e),this.options=c.extend({addDisplayUrl:null,elementTypes:{},addElementTitle:null,editElementTitle:null,deleteConfirm:null,saveChangesAlert:null},t),this.submitRequired=[],c(".drts-display-add-display").on("click",function(e){if(d.isSubmitRequired())alert(d.options.saveChangesAlert);else{var t=c(e.currentTarget);DRTS.ajax({type:"get",container:"#drts-modal",url:d.options.addDisplayUrl,data:{display_type:t.data("display-type"),display_name:t.data("display-name")},trigger:t,cache:!0,cacheId:d.options.addDisplayUrl+t.data("display-type")+"-"+t.data("display-name")})}}),c(".drts-display-delete-display").on("click",function(e){var t=c(e.currentTarget).parent(".drts-display-tab2-link");if(t.length){if(!confirm(d.options.deleteConfirm))return!1;var a={display_type:t.data("display-type"),display_name:t.data("display-name")};return a[DRTS.params.token]=d.form.find('input[name="'+DRTS.params.token+'"]').val(),DRTS.ajax({type:"post",url:d.options.deleteDisplayUrl,data:a,trigger:t,onSuccess:function(e,t,a){a.fadeTo("fast",0,function(){a.slideUp("fast",function(){a.remove()}),a.hasClass(DRTS.bsPrefix+"active")&&a.parent().find(".drts-display-tab2-link-default").click()});var l=a.closest("."+DRTS.bsPrefix+"tab-pane").find(".drts-display-add-display");l.length&&(console.log(d.options.addDisplayUrl+l.data("display-type")+"-"+l.data("display-name")),DRTS.cache(d.options.addDisplayUrl+l.data("display-type")+"-"+l.data("display-name"),!1))}}),!1}}),this.form.on("submit",function(e){d.submitRequired=[]}),c(window).on("beforeunload",function(e){if(d.isSubmitRequired())return""})}return _createClass(a,[{key:"addDisplay",value:function(e,t){DRTS.Display.adminDisplay(this,e,c.extend({},this.options,t))}},{key:"isSubmitRequired",value:function(e,t){if(!e)return 0<this.submitRequired.length;var a=this.submitRequired.indexOf(e);if(-1!==a){if(!1===t)this.submitRequired.splice(a,1);else if(!0!==t)return!0}else if(!0===t)this.submitRequired.push(e);else if(!1!==t)return!1}}]),a}(),DRTS.Display.adminDisplay=function(e,t,o){o=c.extend({selector:t,name:"elements",listElementsUrl:null,addElementUrl:null,editElementUrl:null,deleteElementTitle:null},o);var l,a=function(){var e=c(this);return m(),e.sabaiTooltip("hide"),e.attr("data-modal-title")||e.attr("data-modal-title",e.data("element-type")?o.addElementTitle+" - "+o.elementTypes[e.data("element-type")]:o.addElementTitle),DRTS.ajax({type:"get",container:"#drts-modal",url:o.listElementsUrl,data:e.data("element-type")?{type:e.data("element-type")}:null,onErrorFlash:!0,onContent:function(e,t,a){t.find(".drts-display-elements").off("click",".drts-display-element",d).on("click",".drts-display-element",{parentId:a.closest(".drts-display-element").data("element-id")||0},d)},trigger:e,cache:!0,cacheId:e.data("element-type")?o.listElementsUrl+"-"+e.data("element-type"):o.listElementsUrl}),!1},d=function(e){e.data=e.data||{};var t=c(this),a=t.closest(".drts-display-element"),l=e.data.parentId||a.data("element-id")||0;return m(),t.sabaiTooltip("hide"),t.attr("data-modal-title")||t.attr("data-modal-title",o.addElementTitle+" - "+o.elementTypes[a.data("element-type")]+" - "+a.data("element-label")),DRTS.ajax({type:"get",container:"#drts-modal",url:o.addElementUrl,data:{element:t.data("element-name")},onSendData:function(e,t){},onContent:function(e,t,a){t.find("#drts-display-add-element-parent").val(l)},onErrorFlash:!0,trigger:t,cache:!0,cacheId:"drts-display-element-name-"+t.data("element-name")}),!1},n=function(){var e=c(this),l=e.closest(".drts-display-element");return l.addClass("drts-display-element-editing"),m(),e.attr("data-modal-title")||e.attr("data-modal-title",o.editElementTitle+" - "+o.elementTypes[l.data("element-type")]+" - "+l.data("element-label")+" (ID: "+l.data("element-id")+")"),DRTS.ajax({type:"get",container:"#drts-modal",url:o.editElementUrl,data:{element_id:l.data("element-id")},onContent:function(e,t,a){l.removeClass("drts-display-element-editing")},onErrorFlash:!0,trigger:e,cache:!0,cacheId:"drts-display-element-id-"+l.data("element-id")}),!1},r=function(e,t,a){var l=e.find("> .drts-display-element-title");t.title&&t.title.length?l.find(".drts-display-element-label").html(t.title).removeClass("drts-display-element-no-label"):l.find(".drts-display-element-label").text(t.label).addClass("drts-display-element-no-label"),a&&t.icon&&l.prepend('<span class="drts-display-element-icon"><i class="fa-fw '+t.icon+'"></i></span>')},s=function(){e.isSubmitRequired(o.selector,!0)},i=function(e){e.hasClass("drts-display-element-containable")?e.find("> .drts-display-element-title").effect("highlight",{},1e3):e.effect("highlight",{},1e3)},m=function(){c(o.selector).find(".drts-popover-processed").sabaiPopover("hide")},p={items:"> .drts-display-element",placeholder:"drts-display-element-placeholder",opacity:.8,handle:".drts-display-element-handle",tolerance:"intersect",zIndex:99999,start:function(e,t){var a=t.helper.find(".drts-display-element-title").outerHeight()-2;l=!0,m(),t.helper.height(a).css({overflow:"hidden",width:t.helper.find(".drts-display-element-handle").outerWidth()+32}),t.placeholder.height(a),t.item.data("element-width")&&t.placeholder.css("width",t.item.data("element-width"))},update:function(e,t){s(!0)},over:function(e,t){var a=c(this);a.data("child-element-type")&&t.item.data("element-type")!==a.data("child-element-type")||a.data("child-element-name")&&t.item.data("element-name")!==a.data("child-element-name")||a.data("child-element-attr")&&!t.item.data(a.data("child-element-attr"))||t.item.data("parent-element-name")&&a.closest(".drts-display-element").data("element-name")!==t.item.data("parent-element-name")?(t.item.find(".drts-display-element-handle").css("cursor","no-drop"),t.placeholder.addClass(DRTS.bsPrefix+"bg-danger")):(t.item.find(".drts-display-element-handle").css("cursor","move"),t.placeholder.removeClass(DRTS.bsPrefix+"bg-danger"))},out:function(e,t){t.item.css("cursor","move")},stop:function(e,t){l=!1,t.item.css({overflow:"visible",cursor:"auto"})},receive:function(e,t){var a=c(this);(a.data("child-element-type")&&t.item.data("element-type")!==a.data("child-element-type")||a.data("child-element-name")&&t.item.data("element-name")!==a.data("child-element-name")||a.data("child-element-attr")&&!t.item.data(a.data("child-element-attr"))||t.item.data("parent-element-name")&&a.closest(".drts-display-element").data("element-name")!==t.item.data("parent-element-name"))&&t.sender.sortable("cancel")}};c(".drts-display-element-wrapper",o.selector).each(function(){var e=c(this).sortable(p);e.data("child-element-name")||e.sortable("option","connectWith",o.selector+" .drts-display-element-wrapper:not([data-child-element-name])")}),c(".drts-display-display",o.selector).on("click",".drts-display-element-delete",function(){if(!confirm(o.deleteConfirm))return!1;m();var e=c(this).closest(".drts-display-element");return e.fadeTo("fast",0,function(){e.slideUp("medium",function(){e.remove()})}),s(),!1}),c(DRTS).on("display_element_created.sabai",function(e,t){var a='.drts-display-display[data-display-id="'+t.result.display_id+'"]';t.result.parent_id&&(a+=' .drts-display-element[data-element-id="'+t.result.parent_id+'"]'),a+=" > .drts-display-element-wrapper";var l=c(o.selector).find(a);if(l.length){var d=function a(t,e){var l='<div class="drts-display-element" data-element-id="" data-element-type=""><div class="drts-display-element-title"><span class="drts-display-element-handle"><i class="fas fa-arrows-alt fa-fw fa-lg"></i> <span class="drts-display-element-label"></span></span></div><div class="drts-display-element-control"><div class="drts-bs-btn-group"><button class="drts-display-element-info drts-bs-btn drts-bs-btn-info drts-bs-btn-sm"><i class="fas fa-info fa-fw"></i></button><button class="drts-display-element-edit drts-bs-btn drts-bs-btn-primary drts-bs-btn-sm"><i class="fas fa-cog fa-fw"></i></button><button class="drts-display-element-delete drts-bs-btn drts-bs-btn-danger drts-bs-btn-sm"><i class="fas fa-trash-alt fa-fw"></i></button><button class="drts-display-add-element drts-bs-btn drts-bs-btn-success drts-bs-btn-sm" rel="sabaitooltip" title="'+o.addElementTitle+'" data-placement="right"><i class="fas fa-plus fa-fw"></i></button></div></div><input type="hidden" name="'+o.name+'[]" value="" /></div>',d=c(l).attr("data-element-id",t.id).attr("data-element-type",t.type).attr("data-element-name",t.name).attr("data-element-label",t.label).data("element-data",t.data).addClass("drts-display-element-name-"+t.name).toggleClass("drts-display-element-dimmed",t.dimmed).find('input[name="'+o.name+'[]"]').val(t.id).end().appendTo(e).find('[rel*="sabaitooltip"]').sabaiTooltip({container:e}).end().show();if(t.attr&&c.each(t.attr,function(e,t){d.attr(e,t)}),r(d,t,!0),t.containable){l='<input type="hidden" name="'+o.name+'[]" value="__CHILDREN_START__" /><div class="drts-display-element-wrapper"></div><input type="hidden" name="'+o.name+'[]" value="__CHILDREN_END__" />';var n,s=d.addClass("drts-display-element-containable").append(l).find(".drts-display-add-element").attr("title",t.add_child_label).end().find(" > .drts-display-element-wrapper").sortable(p);if(t.child_element_name)d.find(".drts-display-add-element").attr("data-element-name",t.child_element_name),s.attr("data-child-element-name",t.child_element_name),DRTS.cache("drts-display-element-name-"+t.child_element_name)||c.get(o.addElementUrl,(_defineProperty(n={},DRTS.params.ajax,"#drts-modal"),_defineProperty(n,"element",t.child_element_name),n),function(e){DRTS.cache(o.addElementsUrl+"-"+t.child_element_name,e)});else if(t.child_element_type){var i;d.find(".drts-display-add-element").attr("data-element-type",t.child_element_type),s.attr("data-child-element-type",t.child_element_type),DRTS.cache(o.listElementsUrl+"-"+t.child_element_type)||c.get(o.listElementsUrl,(_defineProperty(i={},DRTS.params.ajax,"#drts-modal"),_defineProperty(i,"type",t.child_element_type),i),function(e){DRTS.cache(o.listElementsUrl+"-"+t.child_element_type,e)}),s.sortable("option","connectWith",".drts-display-element-wrapper")}else s.sortable("option","connectWith",".drts-display-element-wrapper");t.children&&c.each(t.children,function(e,t){a(t,s)})}else d.find(".drts-display-add-element").remove();return d}(t.result,l);i(d),DRTS.cache("drts-display-element-name-"+d.data("element-name"),!1),s()}}),c(DRTS).on("display_element_updated.sabai",function(e,t){var a=c(o.selector).find('.drts-display-element[data-element-id="'+t.result.id+'"]');if(a.length){if(t.result.attr&&c.each(t.result.attr,function(e,t){a.attr(e,t)}),a.toggleClass("drts-display-element-dimmed",t.result.dimmed),t.result.data){a.data("element-data",t.result.data);var l=a.find(".drts-display-element-info");l.hasClass("drts-popover-processed")&&l.removeClass("drts-popover-processed").sabaiPopover("dispose")}r(a,t.result),i(a),DRTS.cache("drts-display-element-id-"+a.data("element-id"),!1)}}),c(function(){c.get(o.listElementsUrl,_defineProperty({},DRTS.params.ajax,"#drts-modal"),function(e){DRTS.cache(o.listElementsUrl,e),c(".drts-display-display",o.selector).on("click",".drts-display-add-element:not([data-element-name])",a),c(".drts-display-add-element-main",o.selector).prop("disabled",!1)}),c(".drts-display-display",o.selector).on("click",".drts-display-element-edit",n).on("click",".drts-display-add-element[data-element-name]",d).on("click",".drts-display-element-info",function(e){var t=c(this);e.preventDefault(),t.toggleClass("drts-display-element-info-clicked").closest(".drts-display-element-control").toggleClass("drts-display-element-info-clicked"),t.off("hidden.bs.popover").on("hidden.bs.popover",function(){t.removeClass("drts-display-element-info-clicked").closest(".drts-display-element-control").removeClass("drts-display-element-info-clicked")})}),c(".drts-display-display",o.selector).hoverIntent({selector:".drts-display-element-info",over:function(e){var t=c(this);if(!l)if(c(o.selector).find(".drts-popover-processed").not(this).sabaiPopover("hide"),t.hasClass("drts-popover-processed"))t.sabaiPopover("show");else{var a=t.closest(".drts-display-element"),i=c("<table></table>"),r=a.data("element-data");i.attr("class","drts-display-element-data "+DRTS.bsPrefix+"table "+DRTS.bsPrefix+"table-bordered "+DRTS.bsPrefix+"table-sm "+DRTS.bsPrefix+"m-0"),Object.keys(r).forEach(function(d){var n=!0,e=Object.keys(r[d].value),s=e.length;e.forEach(function(e){var t=c("<td></td>").text(r[d].value[e].label+":"),a=c("<td></td>"),l=c("<tr></tr>").append(t).append(a).appendTo(i);r[d].value[e].is_html?a.html(r[d].value[e].value):r[d].value[e].is_bool?a.html('<i class="fas '+(r[d].value[e].value?"fa-check":"fa-times")+'"></i>'):a.text(r[d].value[e].value),n&&(l.prepend(c('<th class="'+DRTS.bsPrefix+'table-secondary" rowspan="'+s+'"></th>').text(r[d].label)),n=!1)})}),DRTS.popover(t,{html:!0,trigger:"manual",placement:"top",container:o.selector,content:i,template:'<div class="'+DRTS.bsPrefix+'popover"><div class="'+DRTS.bsPrefix+'arrow"></div><div class="'+DRTS.bsPrefix+"popover-body "+DRTS.bsPrefix+'p-1"></div></div>'})}},out:function(e){c(this).hasClass("drts-display-element-info-clicked")||m()}}),c(".drts-display-display",o.selector).on("click",".drts-display-element-title",function(){var e=c(this);e.hasClass("drts-popover-processed")&&e.sabaiPopover("toggle")})})}}(jQuery);