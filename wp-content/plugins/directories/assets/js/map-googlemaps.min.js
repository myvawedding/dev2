"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function i(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,o){return t&&i(e.prototype,t),o&&i(e,o),e}}(),_get=function e(t,o,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,o);if(void 0===r){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,o,i)}if("value"in r)return r.value;var a=r.get;return void 0!==a?a.call(i):void 0};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}!function(l){DRTS.Map.googlemaps={styles:{}},DRTS.Map.googlemaps.map=function(e){function n(e,t){_classCallCheck(this,n);var o=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t));o.markerClusterer=null,o.overlay=null,o.currentCircle=null;var i=[];for(var r in google.maps.MapTypeId)i.push(google.maps.MapTypeId[r]);var s={mapTypeId:-1!==l.inArray(o.options.type,i)?o.options.type:google.maps.MapTypeId.ROADMAP,mapTypeControl:!(void 0!==o.options.map_type_control&&!o.options.map_type_control),zoomControl:!0,streetViewControl:!1,scaleControl:!1,rotateControl:!1,fullscreenControl:o.options.fullscreen_control||!1,center:new google.maps.LatLng(o.options.default_location.lat,o.options.default_location.lng),scrollwheel:o.options.scrollwheel,styles:o.options.style&&DRTS.Map.googlemaps.styles[o.options.style]?DRTS.Map.googlemaps.styles[o.options.style]:[{featureType:"poi",stylers:[{visibility:"off"}]}],zoom:o.options.default_zoom};if(s.mapTypeControl&&(s.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,mapTypeIds:i,position:google.maps.ControlPosition.TOP_RIGHT}),o.map=new google.maps.Map(o.$map.get(0),s),o.options.marker_clusters){var a={maxZoom:15};o.options.marker_cluster_imgurl&&(a.imagePath=o.options.marker_cluster_imgurl+"/m"),o.markerClusterer=new MarkerClusterer(o.map,[],a)}return o.options.infobox&&(o.getPopover(),o.getOverlay(),google.maps.event.addListener(o.map,"dragstart",function(){o.getPopover().sabaiPopover("hide"),o.currentMarker=null}),google.maps.event.addListener(o.map,"zoom_changed",function(){o.getPopover().sabaiPopover("hide"),o.currentMarker=null})),o.map.getStreetView().setOptions({disableDefaultUI:!0,enableCloseButton:!1,zoomControl:!0,visible:!1}),google.maps.event.addListener(o.map,"click",function(e){o.container.trigger("map_clicked.sabai",{latlng:[e.latLng.lat(),e.latLng.lng()]})}),google.maps.event.addListener(o.map,"zoom_changed",function(e){o.container.trigger("map_zoom_changed.sabai",{zoom:o.map.getZoom()})}),o}return _inherits(n,DRTS.Map.map),_createClass(n,[{key:"clearMarkers",value:function(){for(var e in this.markers)this.markers[e].setMap(null);return this.markerClusterer&&this.markerClusterer.clearMarkers(),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"clearMarkers",this).call(this)}},{key:"addMarker",value:function(e){var t=void 0,o=void 0;if(this.options.marker_custom)if(e.icon){var i={html:e.icon.url?l("<img/>").attr("src",e.icon.url)[0].outerHTML:null,icon:e.icon.icon||this.options.marker_icon,icon_color:e.icon.icon_color||this.options.marker_icon_color,size:e.icon.size||this.options.marker_size,color:e.icon.color||this.options.marker_color||"#fff",event:this.options.infobox_event};t=new DRTS.Map.googlemaps.map.marker(i)}else void 0===o&&(o={icon:this.options.marker_icon||"fas fa-dot-circle",icon_color:this.options.marker_icon_color,size:this.options.marker_size,color:this.options.marker_color||"#fff",event:this.options.infobox_event}),t=new DRTS.Map.googlemaps.map.marker(o);else t=new google.maps.Marker;return t.setPosition(new google.maps.LatLng(e.lat,e.lng)),t.set("id",e.entity_id+"-"+e.index),t.set("content",e.content),t.set("entity_id",e.entity_id),this.markers[t.get("id")]=t,this}},{key:"getMarkerPosition",value:function(e){if(null==e&&(e=Object.keys(this.markers)[0]),!1!=e in this.markers){var t=this.markers[e].getPosition();return[t.lat(),t.lng()]}}},{key:"draw",value:function(e){var o=this;if(e=e||{},this.currentMarker=null,this.currentCircle&&this.currentCircle.setMap(null),0<Object.keys(this.markers).length){var t=void 0;for(var i in(void 0===e.fit_bounds?this.options.fit_bounds:e.fit_bounds)&&1<Object.keys(this.markers).length&&(t=new google.maps.LatLngBounds),this.markers){if(this.markerClusterer||this.markers[i].setMap(this.map),t){var r=this.markers[i].getPosition();t.extend(r),e.center&&t.extend(new google.maps.LatLng(2*e.center[0]-r.lat(),2*e.center[1]-r.lng()))}google.maps.event.addListener(this.markers[i],this.options.infobox_event,function(t){return function(e){o.clickMarker(t)}}(this.markers[i])),Object.keys(this.markers).length<=100&&(this.markers[i].setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(e){return function(){e.setAnimation(null)}}(this.markers[i]),500))}if(this.markerClusterer&&this.markerClusterer.addMarkers(Object.values(this.markers)),t)this.map.fitBounds(t);else if(!e.center){var s=this.markers[Object.keys(this.markers)[0]].getPosition();e.center=[s.lat(),s.lng()]}e.street_view&&this.drawStreetView("object"===_typeof(e.street_view)?e.street_view:this.markers[Object.keys(this.markers)[0]])}if(e.center){var a=new google.maps.LatLng(e.center[0],e.center[1]);this.map.setZoom(e.zoom||this.options.default_zoom||10),this.map.panTo(a),e.circle&&(this.currentCircle=new google.maps.Circle({strokeColor:e.circle.stroke_color||"#99f",strokeOpacity:.8,strokeWeight:1,fillColor:e.circle.fill_color||"#99f",fillOpacity:.3,map:this.map,center:a,radius:e.circle.radius}))}return l(DRTS).trigger("map_drawn.sabai",{map:this}),this}},{key:"clickMarker",value:function(e,t){if(this.currentMarker){if(this.currentMarker.get("id")===e.get("id"))return this.showMarkerContent(e,t),this.currentMarker=e,void(t||this.container.trigger("marker_click.sabai",{map:this,marker:e}));this.currentMarker.setZIndex(0)}e.setZIndex(1),this.markerClusterer&&(this.currentMarker&&this.markerClusterer.addMarker(this.currentMarker),this.markerClusterer.removeMarker(e),e.setMap(this.map)),this.map.getBounds()&&!this.map.getBounds().contains(e.getPosition())&&this.map.panTo(e.getPosition()),this.showMarkerContent(e,t),this.currentMarker=e,t||this.container.trigger("marker_click.sabai",{map:this,marker:e})}},{key:"showMarkerContent",value:function(e,t){var o=this.getPopover();o&&o.sabaiPopover("hide"),!t&&this.options.infobox||(e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},1e3)),(!t||this.options.trigger_infobox)&&o&&this.getOverlay()&&this.getOverlay().getProjection()&&e.get("content")&&this.getPopover(this.getOverlay().getProjection().fromLatLngToContainerPixel(e.getPosition()),e.get("marker_height")||38,e.get("content")).sabaiPopover("show")}},{key:"onResized",value:function(){return this.getOverlay(!0),google.maps.event.trigger(this.map,"resize"),this}},{key:"getZoom",value:function(){return this.map.getZoom()}},{key:"getSouthWest",value:function(){var e=this.map.getBounds();return[e.getSouthWest().lat(),e.getSouthWest().lng()]}},{key:"getNorthEast",value:function(){var e=this.map.getBounds();return[e.getNorthEast().lat(),e.getNorthEast().lng()]}},{key:"getOverlay",value:function(e){return this.overlay&&!e||(this.overlay=new google.maps.OverlayView,this.overlay.draw=function(){},this.overlay.setMap(this.map)),this.overlay}},{key:"drawStreetView",value:function(r,e,s){var t=new google.maps.StreetViewService,a=this.map,n=void 0;return r.setMap&&(r=(n=r).getPosition()),t.getPanorama({location:r,radius:e||50},function(e,t){if(t===google.maps.StreetViewStatus.OK){var o=a.getStreetView();if(o.setPosition(e.location.latLng),n){var i=google.maps.geometry.spherical.computeHeading(e.location.latLng,r);o.setPov({heading:i,pitch:0,zoom:1}),n.setMap(o)}o.setVisible(!0)}else s&&alert("No street map view is available for this location."),console.log(t)}),this}}]),n}(),DRTS.Map.api.getMap=function(e,t){return new DRTS.Map.googlemaps.map(e,t)},DRTS.Map.googlemaps.map.marker=function(e){this.options=e||{},this.visible=!0,this.classes=["drts-map-marker"],this.div=null},DRTS.Map.googlemaps.map.marker.prototype=new google.maps.OverlayView,DRTS.Map.googlemaps.map.marker.prototype.onAdd=function(){var t=this,e=this.options.size||38,o=void 0;this.div=document.createElement("div"),this.div.className=this.classes.join(" "),this.div.style.width=e+"px",this.div.style.height=e+"px",this.div.style.marginTop="-"+(e*Math.sqrt(2)-DRTS.Map.markerHeight(e))+"px",o=document.createElement("div"),this.options.color&&(this.div.style.backgroundColor=this.div.style.color=o.style.borderColor=this.options.color),this.options.data&&(this.div.dataset=this.options.data),this.options.html?o.innerHTML=this.options.html:this.options.icon&&(o.innerHTML='<i class="'+this.options.icon+'"></i>',this.options.icon_color&&(o.style.backgroundColor=this.options.icon_color)),this.div.appendChild(o),this.getPanes().overlayImage.appendChild(this.div);var i=this.options.event;google.maps.event.addDomListener(this.div,i,function(e){google.maps.event.trigger(t,i)}),this.setPosition(this.position),this.set("marker_height",DRTS.Map.markerHeight(e))},DRTS.Map.googlemaps.map.marker.prototype.draw=function(){this.setPosition(this.position)},DRTS.Map.googlemaps.map.marker.prototype.setPosition=function(e){if(this.position=e,this.div){var t=this.getProjection().fromLatLngToDivPixel(this.position);t&&(this.div.style.left=t.x+"px",this.div.style.top=t.y+"px")}},DRTS.Map.googlemaps.map.marker.prototype.onRemove=function(){this.div&&this.div.parentNode.removeChild(this.div),this.div=null},DRTS.Map.googlemaps.map.marker.prototype.getPosition=function(){return this.position},DRTS.Map.googlemaps.map.marker.prototype.setDraggable=function(e){this.draggable=e},DRTS.Map.googlemaps.map.marker.prototype.getDraggable=function(){this.draggable},DRTS.Map.googlemaps.map.marker.prototype.getVisible=function(){return this.visible},DRTS.Map.googlemaps.map.marker.prototype.setVisible=function(e){this.div&&(this.div.style.display=e?"inline-block":"none"),this.visible=e},DRTS.Map.googlemaps.map.marker.prototype.getDraggable=function(){return this.draggable},DRTS.Map.googlemaps.map.marker.prototype.setDraggable=function(e){this.draggable=e},DRTS.Map.googlemaps.map.marker.prototype.setZIndex=function(e){this.zIndex=e,this.div&&(this.div.style.zIndex=this.zIndex)},DRTS.Map.googlemaps.map.marker.prototype.setAnimation=function(e){var t="drts-map-marker-bounce";if(e)-1===this.classes.indexOf(t)&&this.classes.push(t);else{var o=this.classes.indexOf(t);-1<o&&this.classes.splice(o,1)}this.div&&(this.div.className=this.classes.join(" "))}}(jQuery);